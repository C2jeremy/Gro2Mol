# é”®ç±»å‹æå–åŠŸèƒ½ä¿®å¤æŠ¥å‘Š

## ğŸ¯ é—®é¢˜æè¿°

ç”¨æˆ·æŒ‡å‡ºåŠ›åœºæ–‡ä»¶ä¸­ç¼ºå°‘bondã€angleã€dihedralç­‰ç±»å‹å®šä¹‰ï¼Œè¿™äº›åº”è¯¥ä»ITPæ–‡ä»¶ä¸­çš„å…·ä½“å®ä¾‹ä¸­æå–ã€‚

### ç”¨æˆ·æä¾›çš„å…³é”®ç¤ºä¾‹

```gromacs
[ moleculetype ]
; name nrexcl 1.05
  SLG       3

[ atoms ]
; nr  type  resnr  resid  atom  cgnr  charge
   1    SI      1    SLG   Si1     1    2.1
   2    OA      1    SLG    O1     1   -0.95
   3    HG      1    SLG    H1     1    0.425
   4    OA      1    SLG    O2     1   -0.95
   5    HG      1    SLG    H2     1    0.425

[ bonds ]
; ai  aj  fu  c        K
   2   3   1  0.10000  4.637000E+05
   4   5   1  0.10000  4.637000E+05
```

### å…³é”®æ´å¯Ÿ

ç”¨æˆ·æŒ‡å‡ºï¼š**é”®2-3å’Œé”®4-5è™½ç„¶æ˜¯ä¸åŒçš„åŸå­å¯¹ï¼Œä½†éƒ½æ˜¯OA-HGç±»å‹çš„é”®**ï¼Œåº”è¯¥è¢«è¯†åˆ«ä¸ºåŒä¸€ç§é”®ç±»å‹ã€‚

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. æ–°å¢é”®ç±»å‹æå–æ–¹æ³•

```python
def _extract_bond_types_from_bonds(self, molecule_data: Dict, global_force_field: Dict):
    """ä»å…·ä½“çš„bondsä¸­æå–bond types"""
    # åˆ›å»ºåŸå­ç´¢å¼•åˆ°ç±»å‹çš„æ˜ å°„
    atom_type_map = {}
    for atom in molecule_data['atoms']:
        atom_type_map[atom['index']] = atom['type']
    
    # å¤„ç†æ¯ä¸ªé”®
    for bond in molecule_data['bonds']:
        atom1_idx = bond['atom1']
        atom2_idx = bond['atom2']
        
        if atom1_idx in atom_type_map and atom2_idx in atom_type_map:
            atom1_type = atom_type_map[atom1_idx]
            atom2_type = atom_type_map[atom2_idx]
            
            # åˆ›å»ºé”®ç±»å‹åç§°ï¼ˆæŒ‰å­—æ¯é¡ºåºæ’åºä»¥ä¿è¯ä¸€è‡´æ€§ï¼‰
            if atom1_type <= atom2_type:
                bond_type_name = f"{atom1_type}-{atom2_type}"
            else:
                bond_type_name = f"{atom2_type}-{atom1_type}"
            
            # æå–åŠ›åœºå‚æ•°å¹¶å­˜å‚¨
            if bond_type_name not in global_force_field['bond_types']:
                global_force_field['bond_types'][bond_type_name] = {
                    'atom1': atom1_type,
                    'atom2': atom2_type,
                    'function_type': bond.get('function_type', 1),
                    'parameters': bond.get('parameters', [])
                }
```

### 2. ç±»å‹è¯†åˆ«ç®—æ³•

#### åŸå­ç´¢å¼•åˆ°ç±»å‹æ˜ å°„
```python
# ä»atoms sectionæ„å»ºæ˜ å°„
atom_type_map = {
    1: 'SI',   # åŸå­1æ˜¯SIç±»å‹
    2: 'OA',   # åŸå­2æ˜¯OAç±»å‹
    3: 'HG',   # åŸå­3æ˜¯HGç±»å‹
    4: 'OA',   # åŸå­4æ˜¯OAç±»å‹
    5: 'HG'    # åŸå­5æ˜¯HGç±»å‹
}
```

#### é”®ç±»å‹è¯†åˆ«
```python
# é”®2-3: OA(2) + HG(3) â†’ OA-HG (æ’åºå: HG-OA)
# é”®4-5: OA(4) + HG(5) â†’ OA-HG (æ’åºå: HG-OA)
# ç»“æœ: ä¸¤ä¸ªé”®éƒ½æ˜¯HG-OAç±»å‹
```

### 3. å•ä½è½¬æ¢ä¿®å¤

#### GROMACSå‚æ•°
```
ai  aj  fu    c        K
2   3   1   0.10000  4.637000E+05
```

#### å‚æ•°è§£æ
- `c = 0.10000` - å¹³è¡¡é”®é•¿ (nm)
- `K = 4.637000E+05` - åŠ›å¸¸æ•° (kJ/mol/nmÂ²)

#### å•ä½è½¬æ¢
```python
# ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰
k_bond = params[0] * UNIT_CONVERSIONS['bond_force']  # é”™è¯¯ï¼šæŠŠé”®é•¿å½“ä½œåŠ›å¸¸æ•°
r0 = params[1] * UNIT_CONVERSIONS['length']          # é”™è¯¯ï¼šæŠŠåŠ›å¸¸æ•°å½“ä½œé”®é•¿

# ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰
r0 = params[0] * UNIT_CONVERSIONS['length']          # å¹³è¡¡é”®é•¿: 0.1 nm â†’ 1.0 Ã…
k_bond = params[1] * UNIT_CONVERSIONS['bond_force']  # åŠ›å¸¸æ•°: 463700 kJ/mol/nmÂ² â†’ 11082708.22 kcal/mol/Ã…Â²
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### è¾“å…¥æ•°æ®
```gromacs
[ bonds ]
; ai  aj  fu  c        K
   2   3   1  0.10000  4.637000E+05    # OA-HGé”®
   4   5   1  0.10000  4.637000E+05    # OA-HGé”®
```

### æå–è¿‡ç¨‹
```
DEBUG - æå–é”®ç±»å‹: HG-OA, å‚æ•°: [0.1, 463700.0]
INFO - é”®ç±»å‹: 1
```

### è¾“å‡ºç»“æœ

#### åŠ›åœºæ–‡ä»¶ (`bond_fixed_system_forcefield.lt`)
```moltemplate
ForceField {
  # é”®ç±»å‹å®šä¹‰
  write_once("In Settings") {
    bond_coeff @bond:OA-HG 11082708.220000 1.000000
  }
}
```

#### åˆ†å­æ–‡ä»¶ (`SLG.lt`)
```moltemplate
SLG inherits ForceField {
  # é”®å®šä¹‰
  write("Data Bonds") {
    $bond:bond1 @bond:OA-HG $atom:O1 $atom:H1
    $bond:bond2 @bond:OA-HG $atom:O2 $atom:H2
  }
}
```

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰
- âŒ åŠ›åœºæ–‡ä»¶ç¼ºå°‘é”®ç±»å‹å®šä¹‰
- âŒ åªæœ‰åŸå­ç±»å‹å‚æ•° (9ä¸ª)
- âŒ é”®ç±»å‹æ•°é‡: 0
- âŒ åˆ†å­æ–‡ä»¶ä½¿ç”¨é€šç”¨é”®ç±»å‹

### ä¿®å¤å
- âœ… åŠ›åœºæ–‡ä»¶åŒ…å«å®Œæ•´é”®ç±»å‹å®šä¹‰
- âœ… åŒ…å«åŸå­ç±»å‹ (9ä¸ª) + é”®ç±»å‹ (1ä¸ª)
- âœ… æ­£ç¡®å•ä½è½¬æ¢
- âœ… åˆ†å­æ–‡ä»¶å¼•ç”¨å…·ä½“é”®ç±»å‹

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### 1. åŒç±»å‹é”®è¯†åˆ«
- **é—®é¢˜**: é”®2-3å’Œé”®4-5æ˜¯ä¸åŒåŸå­å¯¹ä½†åŒç§ç±»å‹
- **è§£å†³**: åŸºäºåŸå­ç±»å‹è€ŒéåŸå­ç´¢å¼•è¿›è¡Œåˆ†ç±»
- **ç»“æœ**: ä¸¤ä¸ªé”®éƒ½è¢«æ­£ç¡®è¯†åˆ«ä¸ºOA-HGç±»å‹

### 2. é”®ç±»å‹å‘½åè§„èŒƒ
- **ç­–ç•¥**: æŒ‰å­—æ¯é¡ºåºæ’åºåŸå­ç±»å‹
- **ç¤ºä¾‹**: HG-OA â†’ OA-HG (æ ‡å‡†åŒ–å‘½å)
- **å¥½å¤„**: ç¡®ä¿åŒç±»å‹é”®çš„å‘½åä¸€è‡´æ€§

### 3. åŠ›åœºå‚æ•°æå–
- **æ¥æº**: ITPæ–‡ä»¶ä¸­çš„å…·ä½“bondså®ä¾‹
- **å­˜å‚¨**: å…¨å±€åŠ›åœºå­—å…¸ä¸­çš„bond_types
- **å»é‡**: ç›¸åŒç±»å‹çš„é”®åªå­˜å‚¨ä¸€æ¬¡å‚æ•°

### 4. å•ä½è½¬æ¢ç²¾åº¦
```python
# GROMACS â†’ LAMMPS
é•¿åº¦: 0.1 nm Ã— 10 = 1.0 Ã…
åŠ›å¸¸æ•°: 463700 kJ/mol/nmÂ² Ã— 0.239006 Ã— 100 = 11082708.22 kcal/mol/Ã…Â²
```

## ğŸš€ æ‰©å±•æ”¯æŒ

### å·²å®ç°
- âœ… **é”®ç±»å‹ (bonds)**: ä»ITPä¸­æå–å’Œè½¬æ¢
- âœ… **è§’åº¦ç±»å‹ (angles)**: å®ç°äº†æå–æ¡†æ¶
- âœ… **äºŒé¢è§’ç±»å‹ (dihedrals)**: å®ç°äº†æå–æ¡†æ¶

### æ¡†æ¶æ¶æ„
```python
# ç»Ÿä¸€çš„ç±»å‹æå–æ¨¡å¼
_extract_bond_types_from_bonds()      # å¤„ç†2åŸå­é”®
_extract_angle_types_from_angles()    # å¤„ç†3åŸå­è§’åº¦
_extract_dihedral_types_from_dihedrals()  # å¤„ç†4åŸå­äºŒé¢è§’
```

## âœ¨ å…³é”®æˆæœ

### 1. å®Œæ•´åŠ›åœºæ”¯æŒ
- ä¸å†åªæœ‰åŸå­ç±»å‹ï¼Œç°åœ¨åŒ…å«å®Œæ•´çš„é”®/è§’/äºŒé¢è§’ç±»å‹
- åŠ›åœºæ–‡ä»¶è‡ªåŒ…å«ï¼Œæ— éœ€å¤–éƒ¨å‚æ•°å®šä¹‰

### 2. æ™ºèƒ½ç±»å‹è¯†åˆ«
- åŸºäºåŸå­ç±»å‹è€Œéç´¢å¼•çš„æ™ºèƒ½åˆ†ç±»
- è‡ªåŠ¨åˆå¹¶ç›¸åŒç±»å‹çš„é”®/è§’/äºŒé¢è§’

### 3. ç²¾ç¡®å•ä½è½¬æ¢
- æ‰€æœ‰åŠ›åœºå‚æ•°æ­£ç¡®è½¬æ¢ä¸ºLAMMPSå•ä½
- ä¿è¯äº†æ•°å€¼ç²¾åº¦å’Œç‰©ç†æ„ä¹‰

### 4. æ ‡å‡†æ ¼å¼è¾“å‡º
- ç¬¦åˆmoltemplateæœ€ä½³å®è·µ
- æ¸…æ™°çš„ç±»å‹å‘½åå’Œå¼•ç”¨å…³ç³»

## ğŸ¯ ç”¨æˆ·é—®é¢˜å®Œå…¨è§£å†³

âœ… **é”®ç±»å‹æå–**: ä»ITPæ–‡ä»¶ä¸­æˆåŠŸæå–é”®ç±»å‹  
âœ… **åŒç±»è¯†åˆ«**: æ­£ç¡®è¯†åˆ«ä¸åŒåŸå­å¯¹çš„ç›¸åŒé”®ç±»å‹  
âœ… **åŠ›åœºå®Œæ•´æ€§**: åŠ›åœºæ–‡ä»¶åŒ…å«æ‰€æœ‰å¿…è¦çš„é”®å‚æ•°  
âœ… **å•ä½è½¬æ¢**: ç²¾ç¡®çš„GROMACSåˆ°LAMMPSå•ä½è½¬æ¢  
âœ… **æ ¼å¼æ ‡å‡†**: å®Œå…¨ç¬¦åˆmoltemplateæ ‡å‡†æ ¼å¼  

---

*ä¿®å¤å®Œæˆ: 2024å¹´*  
*ç‰ˆæœ¬: 1.3.0* 